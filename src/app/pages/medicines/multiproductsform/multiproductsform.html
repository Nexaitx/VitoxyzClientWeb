<div *ngIf="showToast" class="custom-toast" [class]="'custom-toast--' + toastType">
  <div class="toast-content">
    <mat-icon class="toast-icon">
      {{ toastType === 'success' ? 'check_circle' : 'error' }}
    </mat-icon>
    <span class="toast-message">{{ toastMessage }}</span>
    <button class="toast-close" (click)="showToast = false">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</div>

<!-- Dynamic Banner based on Category -->
@if (categoryName === 'Skin Care') {
  <app-text-banner
    image="assets/medicines/skin-care-banner.avif"
    title="Skin Care Products"
    subtitle="Nourish your skin with our premium care range"
    buttonText="Shop Skin Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Women Care') {
  <app-text-banner
    image="assets/medicines/women-care-banner.avif"
    title="Women Care Products"
    subtitle="Special care for special women"
    buttonText="Shop Women Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Sexual Wellness') {
  <app-text-banner
    image="assets/medicines/sexual-wellness-banner.avif"
    title="Sexual Wellness"
    subtitle="Discreet and reliable products for your intimate health"
    buttonText="Shop Wellness"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Diabetes') {
  <app-text-banner
    image="assets/medicines/diabetes-banner.avif"
    title="Diabetes Care"
    subtitle="Manage diabetes with our comprehensive care products"
    buttonText="Shop Diabetes Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Heart Rate') {
  <app-text-banner
    image="assets/medicines/heart-banner.avif"
    title="Heart Care"
    subtitle="Keep your heart healthy with our specialized products"
    buttonText="Shop Heart Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Stomach Care') {
  <app-text-banner
    image="assets/medicines/stomach-banner.avif"
    title="Stomach Care"
    subtitle="Relief and care for your digestive health"
    buttonText="Shop Stomach Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Liver Care') {
  <app-text-banner
    image="assets/medicines/liver-banner.avif"
    title="Liver Care"
    subtitle="Detoxify and protect your liver"
    buttonText="Shop Liver Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Eye Care') {
  <app-text-banner
    image="assets/medicines/eye-banner.avif"
    title="Eye Care"
    subtitle="Clear vision and healthy eyes"
    buttonText="Shop Eye Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Bone & Joint') {
  <app-text-banner
    image="assets/medicines/bone-banner.avif"
    title="Bone & Joint Care"
    subtitle="Strong bones, flexible joints"
    buttonText="Shop Bone Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Kidney Care') {
  <app-text-banner
    image="assets/medicines/kidney-banner.avif"
    title="Kidney Care"
    subtitle="Healthy kidneys for a healthy life"
    buttonText="Shop Kidney Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else if (categoryName === 'Derma Care') {
  <app-text-banner
    image="assets/medicines/derma-banner.avif"
    title="Dermatological Care"
    subtitle="Specialized care for skin conditions"
    buttonText="Shop Derma Care"
    buttonLink="/medicines">
  </app-text-banner>
} @else {
  <!-- Default Banner -->
  <app-text-banner
    image="assets/medicines/banner.avif"
    title="Welcome to Vitoxyz"
    subtitle="Your trusted health partner"
    buttonText="Shop Now"
    buttonLink="/medicines">
  </app-text-banner>
}




@if (categoryName === 'Skin Care') {
  <app-single-product-form-grid
    [items]="skinCare"
    title="Skin Care Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else if (categoryName === 'Women Care') {
  <app-single-product-form-grid
    [items]="womencare"
    title="Women Care Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else if (categoryName === 'Sexual Wellness') {
  <app-single-product-form-grid
    [items]="sexualcare"
    title="Sexual Wellness Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else if (categoryName === 'Oral Care') {
  <app-single-product-form-grid
    [items]="oralcare"
    title="Oral Care Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else if (categoryName === 'Elder Care') {
  <app-single-product-form-grid
    [items]="eldercare"
    title="Elder Care Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else if (categoryName === 'Baby Care') {
  <app-single-product-form-grid
    [items]="babycare"
    title="Baby Care Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else if (categoryName === 'Men Care') {
  <app-single-product-form-grid
    [items]="mencare"
    title="Men Care Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else if (categoryName === 'Ayurveda') {
  <app-single-product-form-grid
    [items]="ayurveda"
    title="Ayurveda Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else if (categoryName === 'Pet Care') {
  <app-single-product-form-grid
    [items]="petcare"
    title="Pet Care Products"
    [columns]="3">
  </app-single-product-form-grid>
} @else {
  <!-- Default grid -->
  <app-single-product-form-grid
    [items]="productFormsfilter"
    title="Popular Product Forms"
    [columns]="3">
  </app-single-product-form-grid>
}

<!-- <app-common-multifilter-component 
  [config]="{
    endpoint: 'products/filter',
    productForms: ['Tablet', 'Capsule'],
    title: 'Power Up with Multivitamins',
    slideCount: 8,
    autoSlide: true
  }">
</app-common-multifilter-component> -->



<!-- //single form -->
<!-- Single Item -->

<!-- <app-single-product-form-component 
  [config]="{
    productForm: 'Cream',
    label: 'Skin Creams',
    imageUrl: 'assets/cream.avif',
    description: 'Various medicated creams',
    cssClass: 'cream-category'
  }">
</app-single-product-form-component> -->

<!-- Grid Layout -->

<!-- <app-common-multifilter-component 
  [config]="{
    endpoint: 'products/filter',
    productForms: ['Tablet', 'Capsule'],
    title: 'Power Up with Multivitamins',
    slideCount: 8,
    autoSlide: true
  }">
</app-common-multifilter-component> -->


<!-- <app-single-product-form-grid 
  [items]="skinCare"
  title="Skin Care Products"
  [columns]="3">
</app-single-product-form-grid> -->

<!-- Mobile Banner -->
<div class="d-block d-md-none">
  <app-banner-slider [images]="[
    'assets/1.avif',
    'assets/2.avif',
    'assets/3.avif'
  ]" [autoSlide]="true" [slideInterval]="4000">
  </app-banner-slider>
</div>

<!-- Quantity Panel -->
<div *ngIf="showQuantityPanel" class="quantity-panel-overlay" (click)="closeQuantityPanel()"></div>

<div *ngIf="showQuantityPanel" class="quantity-panel">
  <div class="panel-header">
    <h4>Update Quantity</h4>
    <button class="close-panel" (click)="closeQuantityPanel()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="quantity-controls">
    <button class="quantity-btn" (click)="updateQuantity(-1)" [disabled]="quantity <= 1">‚àí</button>
    <div class="quantity-display">{{ quantity }}</div>
    <button class="quantity-btn" (click)="updateQuantity(1)" [disabled]="quantity >= 10">+</button>
  </div>

  <div class="unit-selection">
    <h5>Unit Type</h5>
    <div class="unit-buttons">
      <button *ngFor="let unit of availableUnits" class="unit-btn" [class.active]="selectedUnit === unit"
        (click)="selectUnit(unit)">
        {{ unit }}
      </button>
    </div>
  </div>

  <div class="strength-selection">
    <h5>Strength</h5>
    <div class="strength-buttons">
      <button *ngFor="let strength of availableStrengths" class="strength-btn"
        [class.active]="selectedStrength === strength" (click)="selectStrength(strength)">
        {{ strength }}
      </button>
    </div>
  </div>

  <div class="panel-actions">
    <button class="cancel-btn" (click)="closeQuantityPanel()">Cancel</button>
    <button class="update-btn" (click)="updateCart()">
      Update Cart
    </button>
  </div>
</div>

<!-- Main Page Content -->
<div class="category-page" [class.blur-content]="showQuantityPanel">
   
  <!-- Page Header - No loading here -->
  <header class="page-header">
    <h1 class="page-title">{{ categoryName }}</h1>
  </header>

  <!-- Main Content -->
  <div class="category-layout">

    <!-- Sidebar - Always visible -->
    <div class="sidebar-section">
      <app-sidebar-filter [categories]="categoryList" [brands]="brandList" [disabled]="isLoading || showQuantityPanel"
        (categorySelected)="filterByCategory($event)" (brandSelected)="filterByBrands($event)">
      </app-sidebar-filter>
    </div>

    <!-- Products Section - Loading only here -->
    <div class="products-section">
     
      <div class="section-header">
        <!-- Error State -->
        <div *ngIf="error && !isLoading" class="state-container error-state">
          <div class="error-icon">‚ö†Ô∏è</div>
          <h3>Something went wrong</h3>
          <p>{{ error }}</p>
          <button class="retry-btn" (click)="fetchProducts(productForms, 0, true)">Try Again</button>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoading && !error && products.length === 0" class="state-container empty-state">
          <div class="empty-icon">üì¶</div>
          <h3>No Products Found</h3>
          <p>We couldn't find any products matching "{{ productForms.join(', ') }}".</p>
          <button class="back-home-btn" (click)="goBack()">Browse Other Categories</button>
        </div>

        <!-- Active Filters -->
        <div class="filter-info"
          *ngIf="(selectedCategory$ | async) || ((selectedBrands$ | async) && (selectedBrands$ | async)!.length > 0)">
          <div class="active-filters-container">
            <!-- Category Filter -->
            <span *ngIf="selectedCategory$ | async as selectedCategory" class="active-filter">
              Category: <strong>{{ getCategoryLabel(selectedCategory) }}</strong>
              <button class="clear-filter-btn" (click)="clearFilters()" [disabled]="isLoading || showQuantityPanel">
                √ó
                <span *ngIf="isLoading" class="button-loading"></span>
              </button>
            </span>

            <!-- Brand Filters -->
            <span *ngFor="let brand of (selectedBrands$ | async) || []" class="active-filter">
              Brand: <strong>{{ getBrandLabel(brand) }}</strong>
              <button class="clear-filter-btn" (click)="clearFilters()" [disabled]="isLoading || showQuantityPanel">
                √ó
                <span *ngIf="isLoading" class="button-loading"></span>
              </button>
            </span>
          </div>
        </div>
        
        <!-- Small loading indicator for filter updates -->
        <div *ngIf="isLoading && products.length > 0" class="header-loading">
          <mat-spinner diameter="20" color="primary"></mat-spinner>
          <span>Updating products...</span>
        </div>
      </div>
      
      <!-- Products Grid Container -->
      <div class="product-grid-container">
        
        <!-- Main Loading State - Only shows when initially loading and no products -->
        <div *ngIf="isLoading && products.length === 0" class="products-loading-state">
          <div class="loader-content">
            <mat-spinner diameter="50" color="primary"></mat-spinner>
            <p>Products loading...</p>
            <small>Category: {{ categoryName }}</small>
            <div class="loading-details">
              <small>Please wait while we fetch the products</small>
            </div>
          </div>
        </div>

        <!-- Products Grid - Shows when not loading and has products -->
        <div *ngIf="!isLoading && !error && products.length > 0" class="product-grid">
          <mat-card *ngFor="let product of products" class="product-card mat-elevation-z4" style="cursor: pointer;">
            @if(product.imageUrl) {
              <img (click)="goToProduct(product)" mat-card-image [src]="getFirstImage(product.imageUrl) || '../../../../assets/default.avif'"
                   [alt]="product.name" class="product-image" />
            } @else {
              <img src="../../../../assets/default.avif" alt="">
            }
            <mat-card-content>
              <div class="rating-badge">4.4 ‚òÖ</div>
              <h3 class="product-name">{{ product.name }}</h3>
              <p class="product-form" *ngIf="product.packaging">{{ product.packaging }}</p>
              <div class="price-details-group">
                <div class="price-info">
                  <p class="current-price" *ngIf="product.mrp">
                    <small class="text-muted"> MRP </small>{{ product.mrp | currency:'INR':'symbol':'1.0-0' }}
                  </p>
                  <p class="current-price no-price" *ngIf="!product.mrp">
                    Price not available
                  </p>
                </div>
              </div>
              <div>
                <ng-container *ngIf="(quantities[getProductKey(product)] || 0) === 0; else quantityTemplate">
                 <button class="btn btn-sm w-100 rounded-pill text-light" (click)="addToCart(product, $event)">
                  Add
                </button>
                </ng-container>
               
                <ng-template #quantityTemplate>
                <div class="quantity-control w-100 btn-group rounded-pill text-white btn-group-sm" role="group">
                  <button class="btn text-white left" (click)="decrement(product)">‚àí</button>
                  <span class="btn">{{ quantities[getProductKey(product)] || 0 }}</span>
                  <button class="btn text-white right" (click)="increment(product)">+</button>
                </div>
                </ng-template>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- No Products Message -->
        <div *ngIf="!isLoading && !error && products.length === 0" class="no-products-container">
          <p class="no-products-message">
            Sorry, {{ categoryName }} Product not found.
          </p>
          <button class="clear-filter-btn-large" (click)="clearFilters()"
            [disabled]="isLoading || showQuantityPanel">
            <span *ngIf="isLoading" class="button-spinner"></span>
            Clear Filter
          </button>
        </div>
        
      </div>

      <!-- Load More Section -->
      <div class="load-more-section" *ngIf="hasMoreProducts && !isLoading">
        <button class="load-more-btn" (click)="loadMore()" [disabled]="isLoadMoreLoading">
          <span *ngIf="!isLoadMoreLoading">Load More Products ({{ getRemainingProductsCount() }} more available)</span>
          <span *ngIf="isLoadMoreLoading" class="loading-text">
            <div class="small-spinner"></div>Loading...
          </span>
        </button>
      </div>

    </div>
  </div>
</div>

<app-footer></app-footer>
<app-mobile-footer-nav></app-mobile-footer-nav>