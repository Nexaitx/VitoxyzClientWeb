<div *ngIf="showToast" class="custom-toast" [class]="'custom-toast--' + toastType">
  <div class="toast-content">
    <mat-icon class="toast-icon">
      {{ toastType === 'success' ? 'check_circle' : 'error' }}
    </mat-icon>
    <span class="toast-message">{{ toastMessage }}</span>
    <button class="toast-close" (click)="showToast = false">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</div>

<!-- template... -->
<div class="d-block d-md-none" style="margin-top: -70px">
  <app-banner-slider [images]="[
    'assets/1.png',
    'assets/2.png',
    'assets/3.png'
  ]" [autoSlide]="true" [slideInterval]="4000">
  </app-banner-slider>
</div>

<!-- <app-text-banner
  image="assets/medicines/new banner1 desk.png"
  title="Welcome to Vitoxyz"
  subtitle="Your trusted health partner"
  buttonText="Shop Now"
  buttonLink="/medicines">
</app-text-banner> -->

<!-- ✅ NEW: Quantity Panel -->
<div *ngIf="showQuantityPanel" class="quantity-panel-overlay" (click)="closeQuantityPanel()"></div>

<div *ngIf="showQuantityPanel" class="quantity-panel">
  <div class="panel-header">
    <h4>Update Quantity</h4>
    <button class="close-panel" (click)="closeQuantityPanel()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="quantity-controls">
    <button class="quantity-btn" (click)="updateQuantity(-1)" [disabled]="quantity <= 1">−</button>
    <div class="quantity-display">{{ quantity }}</div>
    <button class="quantity-btn" (click)="updateQuantity(1)" [disabled]="quantity >= 10">+</button>
  </div>

  <div class="unit-selection">
    <h5>Unit Type</h5>
    <div class="unit-buttons">
      <button *ngFor="let unit of availableUnits" class="unit-btn" [class.active]="selectedUnit === unit"
        (click)="selectUnit(unit)">
        {{ unit }}
      </button>
    </div>
  </div>

  <div class="strength-selection">
    <h5>Strength</h5>
    <div class="strength-buttons">
      <button *ngFor="let strength of availableStrengths" class="strength-btn"
        [class.active]="selectedStrength === strength" (click)="selectStrength(strength)">
        {{ strength }}
      </button>
    </div>
  </div>

  <div class="panel-actions">
    <button class="cancel-btn" (click)="closeQuantityPanel()">Cancel</button>
    <button class="update-btn" (click)="updateCart()">
      Update Cart
    </button>
  </div>
</div>

<div class="category-page" [class.blur-content]="isLoading || showQuantityPanel">
  <!-- Full Screen Loader -->
  <div *ngIf="isLoading" class="full-screen-loader">
    <div class="loader-content">
      <mat-spinner diameter="50" color="primary"></mat-spinner>
      <p>Products loading...</p>
      <small>Category: {{ categoryName }}</small>
      <div class="loading-details">
        <small>Filter/Pagination update in progress...</small>
      </div>
    </div>
  </div>

  <div class="category-layout">
    <!-- Left Sidebar -->
    <div class="sidebar-section" [class.sidebar-loading]="isLoading">
      <app-sidebar-filter [categories]="categoryList" [brands]="brandList" [disabled]="isLoading || showQuantityPanel"
        (categorySelected)="filterByCategory($event)" (brandSelected)="filterByBrands($event)">
      </app-sidebar-filter>
    </div>

    <!-- Right Products Section -->
    <div class="products-section">
      <!-- Section Header with Active Filters -->
      <div class="section-header">
        <h2>{{ categoryName }}</h2>

        <!-- Active Filter Display -->
        <div class="filter-info"
          *ngIf="(selectedCategory$ | async) || ((selectedBrands$ | async) && (selectedBrands$ | async)!.length > 0)">
          <div class="active-filters-container">
            <!-- Category Filter -->
            <span *ngIf="selectedCategory$ | async as selectedCategory" class="active-filter">
              Category: <strong>{{ getCategoryLabel(selectedCategory) }}</strong>
              <button class="clear-filter-btn" (click)="clearFilters()" [disabled]="isLoading || showQuantityPanel">
                ×
                <span *ngIf="isLoading" class="button-loading"></span>
              </button>
            </span>

            <!-- Brand Filters -->
            <span *ngFor="let brand of (selectedBrands$ | async) || []" class="active-filter">
              Brand: <strong>{{ getBrandLabel(brand) }}</strong>
              <button class="clear-filter-btn" (click)="clearFilters()" [disabled]="isLoading || showQuantityPanel">
                ×
                <span *ngIf="isLoading" class="button-loading"></span>
              </button>
            </span>
          </div>
        </div>

        <!-- Loading Indicator in Header  <ng-container *ngIf="products.length > 0; else noProducts"> -->
        <div *ngIf="isLoading" class="header-loading">
          <mat-spinner diameter="20" color="primary"></mat-spinner>
          <span>Updating products...</span>
        </div>
      </div>

      <div class="product-grid-container">
        <!-- Products Grid -->
        <div *ngIf="products$ | async as products; else loadingOrNoProducts" class="product-grid">

          <ng-container *ngIf="products.length > 0; else noProducts">
            <mat-card *ngFor="let product of products" class="product-card mat-elevation-z4" style="cursor: pointer;">
            @if(product.imageUrl) {
              <img (click)="goToProduct(product)" mat-card-image [src]="getFirstImageUrl(product.imageUrl) || '../../../../assets/default.png'"
                   [alt]="product.name" class="product-image" />
            } @else {
              <img src="../../../../assets/default.png" alt="">
            }
            <mat-card-content>
              <div class="rating-badge">4.4 ★</div>
              <h3 class="product-name">{{ product.name }}</h3>
              <p class="product-form" *ngIf="product.packaging">{{ product.packaging }}</p>
              <div class="price-details-group">
                <div class="price-info">
                  <p class="current-price" *ngIf="product.mrp">
                    <small class="text-muted"> MRP </small>{{ product.mrp | currency:'INR':'symbol':'1.0-0' }}
                  </p>
                  <p class="current-price no-price" *ngIf="!product.mrp">
                    Price not available
                  </p>
                </div>
              </div>
              <ng-container *ngIf="quantities[product.id ?? product.productId] === 0; else quantityTemplate">
                <button class="btn btn-sm rounded-pill btn-primary text-light" (click)="addToCart(product, $event)">
                  Add
                </button>
              </ng-container>
              <ng-template #quantityTemplate>
                <div class="quantity-control btn-group rounded-pill text-white btn-group-sm" role="group">
                  <button class="btn text-white left" (click)="decrement(product)">−</button>
                  <span class="btn">{{ quantities[product.id ?? product.productId] }}</span>
                  <button class="btn text-white right" (click)="increment(product)">+</button>
                </div>
              </ng-template>
            </mat-card-content>
          </mat-card>
          </ng-container>

          
          <ng-template #noProducts>
            <div class="no-products-container">
              <p class="no-products-message">
                Sorry, {{ categoryName }} Product not found.
              </p>
              <button class="clear-filter-btn-large" (click)="clearFilters()"
                [disabled]="isLoading || showQuantityPanel">
                <span *ngIf="isLoading" class="button-spinner"></span>
                Clear Filter
              </button>
            </div>
          </ng-template>
        </div>

        <!-- Initial Loading Template -->
        <ng-template #loadingOrNoProducts>
          <!-- <div class="loading-container" *ngIf="!isLoading">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Products loading1...</p>
          </div> -->
          <div *ngIf="!isLoading" class="vm-loading" role="status" aria-live="polite">
            <div class="vm-spinner" aria-hidden="true"></div>
            <div class="vm-loading-text">Products loading...</div>
          </div>
        </ng-template>
      </div>

      <!-- Paginator -->
      <mat-paginator
        [length]="totalProducts"
        [pageSize]="pageSize"
        [pageSizeOptions]="[10, 30, 50, 100]"
        (page)="handlePageEvent($event)"
        aria-label="Select page"
        class="product-paginator product-paginator-bottom"
        [disabled]="isLoading"
      ></mat-paginator>
    </div>
  </div>
</div>

<app-footer></app-footer>
<app-mobile-footer-nav></app-mobile-footer-nav>