<div class="orders-container">

  <!-- Tabs -->
   <div class="tabs-wrapper">
  <div class="tabs">
    <button (click)="setTab('upcoming')" [class.active]="activeTab === 'upcoming'">Upcoming</button>
    <button (click)="setTab('ongoing')" [class.active]="activeTab === 'ongoing'">Ongoing</button>
    <button (click)="setTab('past')" [class.active]="activeTab === 'past'">Past</button>
     <button (click)="setTab('completed')" [class.active]="activeTab === 'completed'">
    Booking Completed
  </button>
  <button (click)="setTab('my-cancellations')" [class.active]="activeTab === 'my-cancellations'">
  My Cancellations
</button>
  </div>
</div>
  <!-- Loading / Error -->
  <div class="loading" *ngIf="loading">Loading...</div>
  <div class="error" *ngIf="error">{{ error }}</div>

  <!-- Empty State -->
  <div class="empty" *ngIf="!loading && !error && items.length === 0">
    No bookings found for {{ activeTab }}.
  </div>

  <!-- Booking Cards -->
 
   <div *ngIf="activeTab !== 'completed'">
  <div class="order-card" *ngFor="let b of items">

    <!-- Header -->
    <div class="order-header">
      <div>
        <h3>Booking #{{ b.bookingId }}</h3>
        <p>Placed on {{ b.startDate | date:'dd MMM yyyy' }}</p>
      </div>

      <div class="status-badges">
        <span class="badge pending" *ngIf="b.status === 'Pending'">Pending</span>
        <span class="badge completed" *ngIf="b.status === 'Completed'">Completed</span>
        <span class="badge cancelled" *ngIf="b.status === 'Cancelled'">Cancelled</span>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Booking Details 
      <div class="col">
            
          </div>-->
    <!-- <div class="order-item">
      <div class="details">
        <p><strong>Booking ID:</strong> {{ b.bookingId ?? '‚Äî' }}</p>
        <p><strong>Staff:</strong> {{ b.staffName }}</p>
        <p><strong>Client:</strong> {{ b.clientName }}</p>
        <p><strong>Service From:</strong> {{ b.startDate | date:'medium' }}</p>
        <p><strong>Service To:</strong> {{ b.endDate | date:'medium' }}</p>
      </div>

      <div class="price">
        <p class="amount">‚Çπ{{ b.Price ?? 0 }}</p>
      </div>
    </div> -->

    <div class="order-item">
  <div class="details">
    <p><strong>Booking ID:</strong> {{ b.bookingId ?? '‚Äî' }}</p>
    <p><strong>StaffName:</strong> {{ b.staffName ?? '‚Äî' }}</p>
    <p *ngIf="b.clientName"><strong>Client:</strong> {{ b.clientName }}</p>

    <p><strong>Status:</strong>
      <span class="badge"
        [ngClass]="{
          'bg-success': (b.status || '').toLowerCase() === 'confirmed' || (b.status || '').toLowerCase() === 'accepted',
          'bg-warning text-dark': (b.status || '').toLowerCase() === 'pending',
          'bg-danger': (b.status || '').toLowerCase() === 'cancelled' || (b.status || '').toLowerCase() === 'rejected',
          'bg-secondary': !(b.status)
        }">
        {{ b.status || 'UNKNOWN' }}
      </span>
    </p>

    <p><strong>Service From:</strong> {{ b.startDate | date:'mediumDate' }}</p>
    <p><strong>Service To:</strong> {{ b.endDate | date:'mediumDate' }}</p>

    <p><strong>Time Slot:</strong>
      {{ b.timeSlot || (b.startTimeHour + ':' + b.startTimeMinute + ' ' + b.startTimeAmPm + ' - ' +
                        b.endTimeHour + ':' + b.endTimeMinute + ' ' + b.endTimeAmPm) }}
    </p>

    <p><strong>Category:</strong> {{ b.category }} / {{ b.subCategory }}</p>
    <p><strong>Distance:</strong> {{ b.distanceKm | number:'1.1-1' }} km</p>

    <!-- <p class="text-break">
      <strong>Address:</strong> {{ b.userAddress }}
    </p> -->

    <p><strong>Price:</strong> ‚Çπ{{ b.price }}</p>

    <!-- <p *ngIf="b.expired" class="text-danger"><strong>Expired:</strong> Yes</p>
    <p class="small"><strong>Expiry At:</strong> {{ b.expiryAt | date:'medium' }}</p> -->
  </div>

 
</div>

    <div class="divider"></div>

    <!-- Footer -->
    <div class="order-footer">
      <button class="btn view" (click)="viewStaffDetails(b.staffId)">üëÅ View Details</button>
    <button class="btn reorder" (click)="openReorderModal(b)">‚Üª Reorder</button>
      <button class="btn cancel" (click)="openCancelModal(b)">
  ‚úñ Cancel
</button>
    </div>

  </div>
</div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="pages[activeTab] as p">
    <button (click)="goToPage(0)" [disabled]="p.first">First</button>
    <button (click)="goToPage(page - 1)" [disabled]="p.first">Prev</button>
    <span>Page {{ p.currentPage + 1 }} / {{ p.totalPages }}</span>
    <button (click)="goToPage(page + 1)" [disabled]="p.last">Next</button>
    <button (click)="goToPage(p.totalPages - 1)" [disabled]="p.last">Last</button>
  </div>
  <!-- COMPLETED BOOKINGS VIEW -->
<div *ngIf="activeTab === 'completed'">

  <div class="order-card" *ngFor="let b of completedBookings">

    <!-- Header -->
     <div class="order-header">
      <div>
        <h3>Booking #{{ b.bookingId }}</h3>
        <p>Placed on {{ b.startDate | date:'dd MMM yyyy' }}</p>
      </div>

      <!-- <div class="status-badges">
        
        <span class="badge completed" *ngIf="b.status === 'Completed'">Completed</span>
       
      </div> -->
    </div>

    <div class="divider"></div>

    <!-- Booking Details 
      <div class="col">
            
          </div>-->
    <!-- <div class="order-item">
      <div class="details">
        <p><strong>Booking ID:</strong> {{ b.bookingId ?? '‚Äî' }}</p>
        <p><strong>Staff:</strong> {{ b.staffName }}</p>
        <p><strong>Client:</strong> {{ b.clientName }}</p>
        <p><strong>Service From:</strong> {{ b.startDate | date:'medium' }}</p>
        <p><strong>Service To:</strong> {{ b.endDate | date:'medium' }}</p>
      </div>

      <div class="price">
        <p class="amount">‚Çπ{{ b.Price ?? 0 }}</p>
      </div>
    </div> -->

    <div class="order-item">
  <div class="details">
    <p><strong>Booking ID:</strong> {{ b.bookingId ?? '‚Äî' }}</p>
    <p><strong>StaffName:</strong> {{ b.staffName ?? '‚Äî' }}</p>
    <p><strong>StaffId:</strong> {{ b.staffId ?? '‚Äî' }}</p>
    <p *ngIf="b.clientName"><strong>Client:</strong> {{ b.clientName }}</p>
    <p><strong>Service From:</strong> {{ b.startDate | date:'mediumDate' }}</p>
    <p><strong>Service To:</strong> {{ b.endDate | date:'mediumDate' }}</p>
      <p><strong>Status:</strong>
        
      <span class="statusbgcls  "
        [ngClass]="{
          'bg-success  ': (b.status || '').toLowerCase() === 'confirmed' || (b.status || '').toLowerCase() === 'accepted',
          'bg-warning text-dark': (b.status || '').toLowerCase() === 'pending',
          'bg-danger': (b.status || '').toLowerCase() === 'cancelled' || (b.status || '').toLowerCase() === 'rejected',
          'bg-secondary': !(b.status)
        }">
        {{ b.status || 'UNKNOWN' }}
      </span>
    </p>
     <!-- <p><strong>CreatedAt:</strong> {{ b.createdAt }} </p> -->
    <p><strong>Time Slot:</strong>
      {{ b.timeSlot || (b.startTimeHour + ':' + b.startTimeMinute + ' ' + b.startTimeAmPm + ' - ' +
                        b.endTimeHour + ':' + b.endTimeMinute + ' ' + b.endTimeAmPm) }}
    </p>
     <!-- <p><strong>UpdatedAt:</strong> {{ b.updatedAt }} </p> -->
    <p><strong>Category:</strong> {{ b.staffCategory }} </p>
    <p><strong>StaffPhone:</strong> {{maskPhone(b.staffPhone ) }}</p>
    <!-- <p><strong>StaffEmail:</strong> {{ b.staffEmail  }}</p> -->
    <p><strong>StaffProfession:</strong> {{ b.staffProfession  }}</p>
    <p><strong>StaffRating:</strong> {{ b.staffRating  }}</p>
    <!-- <p><strong>PaymentId:</strong> {{ b.paymentId  }}</p> -->
    <p><strong>PaymentStatus:</strong> {{ b.paymentStatus  }}</p>
    <p><strong>PaymentAmount:</strong> {{ b.paymentAmount  }}</p>



  </div>

 
</div>

    <div class="divider"></div>

    <!-- Footer -->
    <div class="order-footer">
      <button class="btn view" (click)="viewStaffDetails(b.staffId)">
        üëÅ View Staff
      </button>
    </div>

  </div>

</div>
<!-- MY CANCELLATIONS VIEW -->
<div *ngIf="activeTab === 'my-cancellations'">

  <!-- <div class="empty"
       *ngIf="!loading && !error && cancellations.length === 0">
    No cancellations found.
  </div> -->

  <div class="order-card" *ngFor="let c of cancellations">

    <div class="order-header">
      <div>
        <h3>Booking #{{ c.bookingId }}</h3>
        <p>Cancelled on {{ c.cancelledAt | date:'dd MMM yyyy, hh:mm a' }}</p>
      </div>
    </div>

    <div class="divider"></div>

    <div class="order-item">
      <div class="details">

        <p><strong>Cancellation ID:</strong> {{ c.cancellationId }}</p>

        <p><strong>Reason:</strong> {{ c.reason }}</p>

        <p><strong>Cancellation Type:</strong> {{ c.cancellationType }}</p>

        <p><strong>Booking Amount:</strong> ‚Çπ{{ c.bookingAmount }}</p>

        <p>
          <strong>Refund Amount:</strong>
          ‚Çπ{{ c.refundAmount }}
        </p>

        <p>
          <strong>Refund Status:</strong>
          <span class="badge"
                [ngClass]="{
                  'bg-success': c.refundStatus === 'PROCESSED',
                  'bg-warning text-dark': c.refundStatus !== 'PROCESSED'
                }">
            {{ c.refundStatus }}
          </span>
        </p>

        <p><strong>Refunded:</strong> {{ c.isRefunded ? 'Yes' : 'No' }}</p>

        <p *ngIf="c.refundTransactionId">
          <strong>Transaction ID:</strong> {{ c.refundTransactionId }}
        </p>

        <p>
          <strong>Eligible For Refund:</strong>
          {{ c.isEligibleForRefund ? 'Yes' : 'No' }}
        </p>

      </div>
    </div>

  </div>
</div>

<!-- Reorder Modal -->
<div *ngIf="reorderOpen" class="reorder-modal-backdrop">
  <div class="reorder-modal">
    <h4>Reorder Booking(s)</h4>

    <form [formGroup]="overrideForm" (ngSubmit)="submitOverride()">

      <!-- <div class="form-row">
        <label>User Latitude</label>
        <input type="number" step="0.000001" formControlName="userLatitude" />
        <label>User Longitude</label>
        <input type="number" step="0.000001" formControlName="userLongitude" />
      </div> -->

      <div formArrayName="bookings">
        <div *ngFor="let bCtrl of overrideBookings.controls; let idx = index" [formGroupName]="idx" class="booking-row">
          <h5>Booking #{{ idx + 1 }}</h5>
          <label>Staff ID</label>
          <input type="number" formControlName="staffId" />
           
          <label>Start Date</label>
          <input type="date" formControlName="startDate" />

          <label>End Date</label>
          <input type="date" formControlName="endDate" />

          <div class="time-row">
            <div>
              <label>Start Time Hour</label>
              <input type="text" formControlName="startTimeHour" />
            </div>
            <div>
              <label>Start Time Minute</label>
              <input type="text" formControlName="startTimeMinute" />
            </div>
            <div>
              <label>Start AM/PM</label>
              <select formControlName="startTimeAmPm">
                <option value="am">am</option>
                <option value="pm">pm</option>
              </select>
            </div>
          </div>

          <div class="time-row">
            <div>
              <label>End Time Hour</label>
              <input type="text" formControlName="endTimeHour" />
            </div>
            <div>
              <label>End Time Minute</label>
              <input type="text" formControlName="endTimeMinute" />
            </div>
            <div>
              <label>End AM/PM</label>
              <select formControlName="endTimeAmPm">
                <option value="am">am</option>
                <option value="pm">pm</option>
              </select>
            </div>
          </div>

          <label>Override Reason</label>
          <input type="text" formControlName="overrideReason" />
          <hr />
        </div>
      </div>

      <div class="modal-actions">
        <!-- <button type="button" (click)="addBookingRow()">+ Add booking</button> -->
        <button type="submit" class=" text-light overridebtn " [disabled]="overrideSubmitting">Send Override</button>
        <button type="button" class="text-light overridebtn " (click)="closeReorderModal()">Close</button>
      </div>
    </form>

    <!-- Results -->
    <div *ngIf="overrideResult">
      <h5>Result</h5>
      <p><strong>{{ overrideResult.message }}</strong></p>
      <div *ngIf="overrideResult.results?.length">
        <div *ngFor="let r of overrideResult.results">
          <p>staffId: {{ r.staffId }} ‚Äî {{ r.message }} ‚Äî status: {{ r.status }} ‚Äî bookingId: {{ r.bookingId }}</p>
        </div>
      </div>
    </div>

    <div *ngIf="overrideError" class="text-danger">
      {{ overrideError }}
    </div>
  </div>
</div>

<!-- View Staff Details Popup -->
<div class="modal-backdrop" *ngIf="viewDetailsOpen">
  <div class="modal-card">

    <h3>Staff Details</h3>

    <div *ngIf="staffDetailsLoading">Loading...</div>
    <div *ngIf="staffDetailsError" class="text-danger">
      {{ staffDetailsError }}
    </div>

    <div *ngIf="staffDetails">

      <p><strong>Name:</strong> {{ staffDetails.name }}</p>
      <p><strong>StaffId:</strong> {{ staffDetails.staffId }}</p>
      <p><strong>Phone:</strong> {{ maskPhone(staffDetails.phoneNumber) }}</p>
      <p><strong>Gender:</strong> {{ staffDetails.gender }}</p>
      <p><strong>Profession:</strong> {{ staffDetails.profession }}</p>
      <p><strong>Qualification:</strong> {{ staffDetails.qualification }}</p>
      <p><strong>Experience:</strong> {{ staffDetails.experience }} yrs</p>
      <p><strong>Rating:</strong> {{ staffDetails.rating }}</p>

      <p><strong>Category:</strong>
        {{ staffDetails.category }} / {{ staffDetails.subCategory }}
      </p>

      <p><strong>Address:</strong>
        {{ staffDetails.fullAddress }}
       
      </p>
      <p><strong>state:</strong> {{ staffDetails.state }}</p>
      <p><strong>country:</strong> {{ staffDetails.country }}</p>
      <p><strong>Duties:</strong> {{ staffDetails.duties }}</p>
      <p><strong>Degree:</strong> {{ staffDetails.degree }}</p>
      <!-- <h4>Pricing</h4>
      <p>8 Hours: ‚Çπ{{ staffDetails.eightHourPrice }}</p>
      <p>12 Hours: ‚Çπ{{ staffDetails.twelveHourPrice }}</p>
      <p>24 Hours: ‚Çπ{{ staffDetails.twentyFourHourPrice }}</p>
      <p *ngIf="staffDetails.weeklyPrice">
        Weekly: ‚Çπ{{ staffDetails.weeklyPrice }}
      </p> -->

    </div>

    <div class="text-end mt-2">
      <button class="btn cancel text-white" (click)="closeViewDetails()">Close</button>
    </div>

  </div>
</div>

<!-- Cancel Booking Modal -->
<div class="modal-backdrop" *ngIf="cancelModalOpen">
  <div class="modal-card">

    <h3>Cancel Booking</h3>

    <p><strong>Booking ID:</strong> {{ cancelBookingId }}</p>

    <textarea
      rows="4"
      placeholder="Enter cancellation reason"
      [(ngModel)]="cancelReason"
      class="form-control">
    </textarea>

    <div class="mt-3 text-end">
      <button class="btn btn-secondary text-light me-2" (click)="closeCancelModal()">
        Close
      </button>

      <button
        class="btn btn-danger"
        [disabled]="cancelSubmitting || !cancelReason"
        (click)="confirmCancelBooking()">
        {{ cancelSubmitting ? 'Cancelling...' : 'Confirm Cancel' }}
      </button>
    </div>

    <!-- Result Message -->
    <div *ngIf="cancelResult" class="mt-3">
      <p class="fw-bold">{{ cancelResult }}</p>
    </div>

  </div>
</div>


</div>
