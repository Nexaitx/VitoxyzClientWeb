import{a as b}from"./chunk-TNRG4YRG.js";import{y as I}from"./chunk-HSQUREWB.js";import{_ as s,a as l,b as h,ca as m,ha as y,l as c,p as n}from"./chunk-36LOJXOE.js";var f=class i{_notification$=new c(null);notification$=this._notification$.asObservable();showSuccess(t,e=3e3){this._notification$.next({message:t,type:"success",duration:e}),setTimeout(()=>this.clear(),e)}showError(t,e=5e3){this._notification$.next({message:t,type:"error",duration:e}),setTimeout(()=>this.clear(),e)}clear(){this._notification$.next(null)}static \u0275fac=function(e){return new(e||i)};static \u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})};var v=class i{http=y(I);API_BASE=`${b}/cart`;_cart$=new c([]);cart$=this._cart$.asObservable();_loading$=new c(!1);loading$=this._loading$.asObservable();_itemLoadingStates$=new c({});itemLoadingStates$=this._itemLoadingStates$.asObservable();_successNotification$=new c(null);successNotification$=this._successNotification$.asObservable();notificationService=y(f);LOCAL_STORAGE_KEY="localCart";constructor(){this.loadLocalCart()}setItemLoading(t,e){let o=this._itemLoadingStates$.value;if(e)this._itemLoadingStates$.next(h(l({},o),{[t]:!0}));else{let a=l({},o);delete a[t],this._itemLoadingStates$.next(a)}}setLoading(t){this._loading$.next(t)}showSuccessNotification(t){this._successNotification$.next(t),setTimeout(()=>{this._successNotification$.next(null)},3e3)}loadLocalCart(){let t=localStorage.getItem(this.LOCAL_STORAGE_KEY);if(t){let e=JSON.parse(t);console.log("\u{1F6D2} Loading local cart from storage:",e),this._cart$.next(e)}else console.log("\u{1F6D2} No local cart found in storage")}saveLocalCart(t){console.log("\u{1F4BE} Saving cart to local storage:",t),localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this._cart$.next(t)}addToLocalCart(t){console.log("Adding to local cart:",t);let e=this._cart$.value,o=e.findIndex(r=>r.id===t.id),a;o>-1?(a=[...e],a[o]=h(l({},a[o]),{count:a[o].count+(t.count||1)})):a=[...e,h(l({},t),{count:t.count||1})],this.saveLocalCart(a)}removeFromLocalCart(t){console.log("\u{1F5D1}\uFE0F Removing from local cart:",t);let o=this._cart$.value.filter(a=>a.id!==t);this.saveLocalCart(o)}updateLocalCartQuantity(t,e){console.log("\u{1F4DD} Updating local cart quantity:",t,e);let a=this._cart$.value.map(r=>r.id===t?h(l({},r),{count:e}):r);this.saveLocalCart(a)}syncLocalCartToBackend(){let t=this._cart$.value,e=localStorage.getItem("authToken");if(console.log("\u{1F504} Starting cart sync..."),console.log("\u{1F511} Token exists:",!!e),console.log("\u{1F6D2} Local cart items to sync:",t),!e)return console.log("\u274C No token found, skipping sync"),this.showSuccessNotification("Please login to sync your cart"),n({success:!1,message:"No authentication token"});if(t.length===0)return console.log("\u2139\uFE0F Local cart is empty, skipping sync"),n({success:!0,message:"Empty cart"});this.setLoading(!0);let o=t.map(a=>({medicineId:a.id,quantity:a.count,productType:a.productType||"otc"}));return console.log("\u{1F4E4} Syncing items to backend via bulk API:",o),this.http.post(`${this.API_BASE}/sync-local`,{items:o},{headers:{Authorization:`Bearer ${e}`}}).pipe(s({next:a=>{console.log("\u2705 Sync API response:",a),this.setLoading(!1),a.status?(console.log("\u{1F3AF} Sync successful, clearing local cart"),this.showSuccessNotification("Cart synced successfully!"),localStorage.removeItem(this.LOCAL_STORAGE_KEY),console.log("\u{1F5D1}\uFE0F Local cart cleared from storage"),setTimeout(()=>{this.fetchCartFromBackend().subscribe()},1e3)):(console.error("\u274C Sync failed in API response:",a.message),this.showSuccessNotification("Cart sync failed. Using local cart."))},error:a=>{console.error("\u274C Sync API error:",a),this.setLoading(!1),this.showSuccessNotification("Cart sync failed. Using local cart.")}}))}fetchCartFromBackend(){let t=localStorage.getItem("authToken");return t?(console.log("\u{1F4E5} Fetching cart from backend..."),this.setLoading(!0),this.http.get(`${this.API_BASE}/my`,{headers:{Authorization:`Bearer ${t}`}}).pipe(s(e=>{if(console.log("\u{1F4E6} Backend cart response:",e),this.setLoading(!1),e&&e.status)if(e.data&&Array.isArray(e.data)&&e.data.length>0){let o=e.data.map(a=>{let r="assets/no-image.png";return a.imageUrl&&(r=a.imageUrl.split("|")[0].trim()),{id:a.medicineManagementId||a.medicineId,medicineId:a.medicineId,name:a.productName,image:r,qty:a?.quantity?.toString()||"1",price:a.price,mrp:a.mrp||a.price,count:a.quantity||1,productType:a.productType}});console.log("\u2705 Processed backend cart items:",o),this._cart$.next(o)}else console.log("\u2139\uFE0F Backend cart is empty"),this._cart$.next([]);else console.error("\u274C Invalid backend response format"),this._cart$.next([])}),s({error:e=>{console.error("\u274C Error fetching backend cart:",e),this.setLoading(!1),console.log("\u{1F504} Falling back to local cart due to backend error"),this.loadLocalCart()}}))):(console.log("\u274C No token for backend fetch"),n(null))}addItem(t,e=1){let o=localStorage.getItem("authToken"),a={id:t.managementId||t.id||t.productId||t.medicineId,name:t.name,price:t.price||t.discountPrice||t.originalPrice,mrp:t.originalPrice,image:t.image||this.getFirstImageUrl(t.imageUrls),qty:t.productForm||t.packaging||"1",count:e,productType:t.productType||"otc"};if(console.log("\u{1F6D2} Adding item to cart - Token exists:",!!o),console.log("\u{1F4E6} Product details:",t),!o)return this.addToLocalCart(a),this.notificationService.showSuccess(`${t.name} added to cart successfully!`),n(a);let r=t.managementId,u=t.medicineId||t.id||t.productId;if(!r&&!u)return console.error("\u274C Both managementId and medicineId are missing",t),this.addToLocalCart(a),this.notificationService.showSuccess(`${t.name} added to cart successfully!`),n(a);let p=r||u;this.setItemLoading(p.toString(),!0);let g={quantity:e,productType:t.productType||"otc"};return r?g.medicineManagementId=r:u&&(g.medicineId=u),console.log("\u{1F4E4} Backend payload:",g),this.http.post(`${this.API_BASE}/add`,g,{headers:{Authorization:`Bearer ${o}`}}).pipe(s({next:d=>{this.setItemLoading(p.toString(),!1),d&&d.status?(this.notificationService.showSuccess(`${t.name} added to cart successfully!`),setTimeout(()=>{this.fetchCartFromBackend().subscribe()},500)):(console.warn("\u26A0\uFE0F Backend add failed, using local cart"),this.addToLocalCart(a),this.notificationService.showSuccess(`${t.name} added to cart successfully!`))},error:d=>{this.setItemLoading(p.toString(),!1),console.error("\u274C Backend add error:",d),this.addToLocalCart(a),this.notificationService.showSuccess(`${t.name} added to cart successfully!`)}}))}getFirstImageUrl(t){return t?Array.isArray(t)?t.length>0?t[0]:"assets/no-image.png":typeof t=="string"&&t.split("|")[0].trim()||"assets/no-image.png":"assets/no-image.png"}removeItem(t){let e=localStorage.getItem("authToken");return console.log("\u{1F5D1}\uFE0F Removing item from cart:",t),this.setItemLoading(t,!0),this.removeFromLocalCart(t),e?this.tryRemoveWithManagementId(t).pipe(s({next:()=>{this.setItemLoading(t,!1),console.log("\u2705 Remove successful with managementId endpoint"),this.showSuccessNotification("Item removed from cart"),this.fetchCartFromBackend().subscribe()},error:o=>{console.error("\u274C ManagementId remove failed, trying medicineId endpoint:",o),this.tryRemoveWithMedicineId(t).subscribe({next:()=>{this.setItemLoading(t,!1),console.log("\u2705 Remove successful with medicineId endpoint"),this.showSuccessNotification("Item removed from cart"),this.fetchCartFromBackend().subscribe()},error:a=>{this.setItemLoading(t,!1),console.error("\u274C Both remove methods failed:",a),this.showSuccessNotification("Item removed from cart (local only)")}})}})):(console.log("\u{1F464} User not logged in, removed from local storage only"),this.setItemLoading(t,!1),this.showSuccessNotification("Item removed from cart"),n(null))}tryRemoveWithManagementId(t){let e=localStorage.getItem("authToken");return console.log("\u{1F527} Trying remove with managementId endpoint"),this.http.delete(`${this.API_BASE}/remove/${t}`,{headers:{Authorization:`Bearer ${e}`}})}tryRemoveWithMedicineId(t){let e=localStorage.getItem("authToken");return console.log("\u{1F527} Trying remove with medicineId endpoint"),this.http.delete(`${this.API_BASE}/remove/${t}`,{headers:{Authorization:`Bearer ${e}`}})}incrementQty(t){let e=localStorage.getItem("authToken");if(this.setItemLoading(t,!0),!e){let a=this._cart$.value.find(r=>r.id===t);return a&&this.updateLocalCartQuantity(t,a.count+1),this.setItemLoading(t,!1),n(null)}return this.http.put(`${this.API_BASE}/increment/${t}`,{},{headers:{Authorization:`Bearer ${e}`}}).pipe(s({next:()=>{this.setItemLoading(t,!1),this.fetchCartFromBackend().subscribe()},error:o=>{this.setItemLoading(t,!1),console.error("\u274C Increment failed with managementId, trying fallback:",o),this.http.put(`${this.API_BASE}/increment/${t}`,{},{headers:{Authorization:`Bearer ${e}`}}).subscribe({next:()=>{this.fetchCartFromBackend().subscribe()},error:a=>{console.error("\u274C Both increment methods failed:",a)}})}}))}decrementQty(t){let e=localStorage.getItem("authToken");if(this.setItemLoading(t,!0),!e){let a=this._cart$.value.find(r=>r.id===t);return a&&a.count>1?this.updateLocalCartQuantity(t,a.count-1):a&&a.count===1&&this.removeFromLocalCart(t),this.setItemLoading(t,!1),n(null)}return this.http.put(`${this.API_BASE}/decrement/${t}`,{},{headers:{Authorization:`Bearer ${e}`}}).pipe(s({next:()=>{this.setItemLoading(t,!1),this.fetchCartFromBackend().subscribe()},error:o=>{this.setItemLoading(t,!1),console.error("\u274C Decrement failed with managementId, trying fallback:",o),this.http.put(`${this.API_BASE}/decrement/${t}`,{},{headers:{Authorization:`Bearer ${e}`}}).subscribe({next:()=>{this.fetchCartFromBackend().subscribe()},error:a=>{console.error("\u274C Both decrement methods failed:",a)}})}}))}updateQty(t,e,o="otc"){let a=localStorage.getItem("authToken");return this.setItemLoading(t,!0),a?this.http.post(`${this.API_BASE}/update`,{medicineId:t,quantity:e,productType:o},{headers:{Authorization:`Bearer ${a}`}}).pipe(s({next:()=>{this.setItemLoading(t,!1),this.fetchCartFromBackend().subscribe()},error:r=>{this.setItemLoading(t,!1),console.error("\u274C Update quantity failed:",r)}})):(this.updateLocalCartQuantity(t,e),this.setItemLoading(t,!1),n(null))}clearCart(){let t=localStorage.getItem("authToken");return this.setLoading(!0),localStorage.removeItem(this.LOCAL_STORAGE_KEY),this._cart$.next([]),t?this.http.delete(`${this.API_BASE}/clear`,{headers:{Authorization:`Bearer ${t}`}}).pipe(s({next:()=>{this.setLoading(!1),this.showSuccessNotification("Cart cleared successfully!")},error:e=>{this.setLoading(!1),console.error("\u274C Clear cart failed:",e),this.showSuccessNotification("Cart cleared successfully!")}})):(console.log("\u{1F464} User not logged in, cleared local storage only"),this.setLoading(!1),this.showSuccessNotification("Cart cleared successfully!"),n(null))}fetchCart(){let t=localStorage.getItem("authToken");return console.log("\u{1F504} fetchCart called, logged in:",!!t),t?(console.log("\u{1F464} User logged in, fetching from backend"),this.fetchCartFromBackend()):(console.log("\u{1F464} User not logged in, using local cart"),this.loadLocalCart(),this.cart$)}isLoggedIn(){return!!localStorage.getItem("authToken")}getCurrentCart(){return this._cart$.value}getCartItemCount(){return this._cart$.value.reduce((t,e)=>t+e.count,0)}isItemInCart(t){return this._cart$.value.some(e=>e.id===t)}getItemById(t){return this._cart$.value.find(e=>e.id===t)}isLoading(){return this._loading$.value}isItemLoading(t){return this._itemLoadingStates$.value[t]||!1}getTotalCartValue(){return this._cart$.value.reduce((t,e)=>t+e.price*e.count,0)}getTotalSavings(){return this._cart$.value.reduce((t,e)=>e.mrp&&e.mrp>e.price?t+(e.mrp-e.price)*e.count:t,0)}syncLocalCartSmartMerge(t){let e=localStorage.getItem("authToken");return e?this.http.post(`${this.API_BASE}/sync-local-smart-merge`,t,{headers:{Authorization:`Bearer ${e}`}}):n({success:!1,message:"No authentication token"})}static \u0275fac=function(e){return new(e||i)};static \u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})};export{f as a,v as b};
